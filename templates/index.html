<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rasa & Flask Chatbot</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #222;
        color: #fff;
        margin-top: 50px; /* Move the chat widget down */
      }
      .chat-sign-button {
        width: 50px;
        height: 50px;
        font-size: 24px;
      }
      .chat-widget {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 300px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); /* Add box shadow */
        background-color: #222;
        border: none;
        color: #fff;
        transition: all 0.3s ease; /* Add transition for smooth animation */
      }
      .chat-widget-header {
        background-color: #007bff;
        color: #fff;
        border-radius: 10px 10px 0 0; /* Rounded corners on top */
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
      }
      .chat-widget-messages {
        overflow-y: auto;
        max-height: 300px;
        padding: 10px;
      }
      .chat-widget-footer {
        background-color: #444;
        border-radius: 0 0 10px 10px; /* Rounded corners on bottom */
        padding: 10px;
      }
      .form-control {
        background-color: #333;
        color: #fff;
        border-color: #666;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Welcome to my Chatbot!</h1>
      <button
        id="chat-widget-button"
        type="button"
        class="btn btn-primary rounded-circle position-fixed chat-sign-button"
        style="bottom: 20px; right: 20px"
      ></button>
      <!-- Chatbox -->
      <div id="chat-widget" class="card chat-widget d-none">
        <div class="chat-widget-header">
          <span>Chatbot</span>
          <button
            id="chat-widget-close-button"
            type="button"
            class="btn btn-light"
            aria-label="Close"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="chat-widget-messages" id="chat-widget-messages"></div>
        <div class="chat-widget-footer">
          <input
            type="text"
            class="form-control"
            id="chat-widget-input"
            placeholder="Type your message..."
          />
        </div>
        <!-- Add reset button -->
        <div class="chat-widget-footer">
          <button id="reset-conversation" class="btn btn-danger">
            Reset Conversation
          </button>
          <!-- Add microphone icon button for voice input -->
          <button id="voice-input" class="btn btn-info ml-2">
            <i class="fas fa-microphone"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      // Function to handle voice input
      function handleVoiceInput() {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.onresult = function (event) {
          const userMessage = event.results[0][0].transcript;
          $("#chat-widget-input").val(userMessage);
          $("#chat-widget-input").focus();
        };
        recognition.start();
      }
      $(document).ready(function () {
        $("#chat-widget-button").on("click", function () {
          $("#chat-widget").toggleClass("d-none");
        });
        $("#chat-widget-close-button").on("click", function () {
          $("#chat-widget").addClass("d-none");
        });

        // Attach event handler for voice input button
        $("#voice-input").on("click", function () {
          handleVoiceInput();
        });
        // Reset conversation function
        function resetConversation() {
          $("#chat-widget-messages").empty(); // Clear messages
        }

        // Event handler for reset button
        $("#reset-conversation").on("click", function () {
          resetConversation(); // Call reset conversation function
        });

        // Handle user input in the chat box
        $("#chat-widget-input").keypress(function (event) {
          if (event.which == 13) {
            let userMessage = $("#chat-widget-input").val();
            $("#chat-widget-input").val("");
            // Append user's message to the chatbox
            $("#chat-widget-messages").append(
              "<div><strong>You:</strong> " + escapeHtml(userMessage) + "</div>"
            );
            // Send user's message to the server and get bot's response
            $.ajax({
              type: "POST",
              url: "/webhook",
              contentType: "application/json",
              data: JSON.stringify({ message: userMessage }),
              success: function (data) {
                let botResponse = data.response;
                // Append bot's response to the chatbox
                $("#chat-widget-messages").append(
                  "<div><strong>Bot:</strong> " +
                    escapeHtml(botResponse) +
                    "</div>"
                );
              },
              error: function () {
                // Handle error if needed
              },
            });
          }
        });

        // Function to escape HTML characters
        function escapeHtml(text) {
          return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
      });
    </script>
  </body>
</html>
